@model Project_1.Models.Listing
@using Microsoft.AspNetCore.Identity

@inject UserManager<IdentityUser> userManager

@{
    ViewData["Title"] = "Listing Details";
    Layout = "_Layout";

    var highestBid = Model.Bids?.OrderByDescending(b => b.Price).FirstOrDefault();
    var currentPrice = highestBid?.Price ?? Model.Price;
    var listingId = Model.Id;
    var isListingOwner = userManager.GetUserId(User) == Model.IdentityUserId;
    var currentPriceFormatted = currentPrice.ToString("F2");
}

<div class="container mt-5">
    <div class="card shadow-sm p-4" style="background-color: #fdfbf7; border-radius: 10px;">
        <h1 class="display-4 text-center mb-3" style="color: #4b2c20;">@Model.Title</h1>

        @* ---------- Auction Status Messages ---------- *@
        @if (User.Identity.IsAuthenticated && Model.IsSold && highestBid != null)
        {
            <div class="alert alert-success text-center">
                @if (highestBid.IdentityUserId == userManager.GetUserId(User))
                {
                    <p><strong>Congratulations!</strong> You are the winner with a bid of Rs @highestBid.Price.ToString("N2")!</p>
                }
                else if (isListingOwner)
                {
                    <p><strong>@highestBid.User.UserName</strong> won with a bid of Rs @highestBid.Price.ToString("N2")!</p>
                }
                else
                {
                    <p><strong>Bidding is closed!</strong></p>
                }
            </div>
        }
        else if (Model.IsSold && highestBid == null)
        {
            <div class="alert alert-info text-center">
                <p><strong>Bidding is closed!</strong> No bids were placed on this item.</p>
            </div>
        }

        <div class="row">
            <div class="col-md-5">
                <img src="~/Images/@Model.ImagePath" alt="@Model.Title" class="img-fluid rounded" style="max-height: 60vh;" />
            </div>

            <div class="col-md-7">
                <p class="mb-3" style="color:#4b2c20;">@Model.Description</p>

                @if (User.Identity.IsAuthenticated)
                {
                    <p>
                        Highest Bid: <strong style="color:#b8860b;">
                            Rs <span id="highestBidAmount">@currentPrice.ToString("N2")</span>
                        </strong>
                    </p>

                    @* ---------- Bidding Controls ---------- *@
                    @if (isListingOwner)
                    {
                        <h6>Bidding History:</h6>
                        <ul>
                            @if (Model.Bids != null && Model.Bids.Any())
                            {
                                @foreach (var bid in Model.Bids.OrderByDescending(b => b.Price))
                                {
                                    <li>
                                        @bid.User.UserName bidded Rs @bid.Price.ToString("N2")
                                        @if (!Model.IsSold)
                                        {
                                            <form asp-action="DeleteBid" asp-route-id="@bid.Id" method="post" style="display:inline;">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-sm btn-danger ms-2"
                                                        onclick="return confirm('Are you sure you want to delete this bid?');">
                                                    Delete
                                                </button>
                                            </form>
                                        }
                                    </li>
                                }
                            }
                            else
                            {
                                <li>No bids placed yet.</li>
                            }
                        </ul>

                        @if (!Model.IsSold)
                        {
                            <p class="card-text">
                                <strong>Time Remaining:</strong>
                                <span id="timer-@Model.Id"
                                      data-closing-time="@Model.ClosingTime.ToString("o")"
                                      style="color:@(Model.IsSold ? "red" : "green"); font-weight:bold;">
                                    @(Model.IsSold ? "Bidding Closed" : "")
                                </span>
                            </p>

                            <form asp-action="CloseBidding" asp-route-id="@Model.Id" method="post" class="mt-2">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-danger">Close Bidding</button>
                            </form>

                            <form asp-action="DeleteListing" asp-route-id="@Model.Id" method="post" class="mt-2">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-warning">Delete Listing</button>
                            </form>
                        }
                    }
                    else if (!Model.IsSold)
                    {
                        <form asp-controller="Listings" asp-action="AddBid" method="post" class="mt-4" id="bidForm">
                            <div class="input-group mb-3">
                                <input type="number"
                                       name="Price"
                                       id="bidInputPrice"
                                       class="form-control"
                                       placeholder="Enter your bid (Rs @(currentPrice + 0.01) minimum)"
                                       min="@(currentPrice + 0.01)"
                                       step="0.01"
                                       required />
                                <button type="submit" class="btn btn-warning" id="placeBidButton">Place Bid</button>
                            </div>
                            <input type="hidden" name="ListingId" value="@Model.Id" />
                            <input type="hidden" name="IdentityUserId" value="@userManager.GetUserId(User)" />
                        </form>
                    }
                }
                else
                {
                    <p class="text-muted">Sign in to place a bid.</p>
                }

                <p>Listed by: <strong>@Model.User.UserName</strong></p>
            </div>
        </div>

        @* ---------- Payment Section ---------- *@
        <hr class="my-4" />

        @if (User.Identity.IsAuthenticated && Model.IsSold && highestBid != null)
        {
            if (highestBid.IdentityUserId == userManager.GetUserId(User))
            {
                <div class="text-center mt-3">
                    <p class="text-success fw-bold">🎉 Congratulations! You won this auction.</p>

                    <form asp-controller="Payment" asp-action="CreateCheckoutSession" method="post">
                        <input type="hidden" name="amount" value="@highestBid.Price" />
                        <input type="hidden" name="listingId" value="@Model.Id" />
                        <button type="submit" class="btn btn-success btn-lg">Pay Now</button>
                    </form>
                </div>
            }
            else if (isListingOwner)
            {
                <div class="text-center mt-3">
                    <p class="text-primary fw-bold">
                        The winning bidder <strong>@highestBid.User.UserName</strong> won with Rs @highestBid.Price.ToString("N2").
                        Waiting for payment...
                    </p>
                </div>
            }
        }

        <hr class="my-4" />
        <h5>Comments</h5>

        @if (User.Identity.IsAuthenticated)
        {
            <form asp-action="AddComment" method="post" class="mb-3">
                <textarea name="Content" class="form-control mb-2" rows="3" placeholder="Add a comment..."></textarea>
                <input type="hidden" name="IdentityUserId" value="@userManager.GetUserId(User)" />
                <input type="hidden" name="ListingId" value="@Model.Id" />
                <button type="submit" class="btn btn-gold">Submit Comment</button>
            </form>
        }
        else
        {
            <textarea class="form-control mb-2" rows="3" placeholder="Sign in to comment..." disabled></textarea>
            <button class="btn btn-secondary" disabled>Submit Comment</button>
        }

        <div class="mt-3">
            @{
                int commentNumber = 1;
            }
            @foreach (var comment in Model.Comments)
            {
                <div class="border p-2 mb-2 rounded" style="background-color:#fff8e7; color:#4b2c20;">
                    <strong>@commentNumber. @comment.User.UserName:</strong> @comment.Content
                </div>
                commentNumber++;
            }
        </div>
    </div>
</div>

@* ---------------------------- SignalR for Real-time Bids ---------------------------- *@
<script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
<script>
    const currentListingId = @listingId;
    const bidInput = document.getElementById("bidInputPrice");
    const highestBidElement = document.getElementById("highestBidAmount");

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/bidHub")
        .build();

    connection.on("ReceiveNewHighestBid", function (newHighestBidAmount) {
        if (highestBidElement) {
            highestBidElement.innerText = newHighestBidAmount;
        }
        if (bidInput) {
            const newMinBid = (parseFloat(newHighestBidAmount) + 0.01).toFixed(2);
            bidInput.min = newMinBid;
            bidInput.placeholder = `Enter your bid (Rs ${newMinBid} minimum)`;
        }
    });

    connection.start().then(function () {
        connection.invoke("JoinListingGroup", currentListingId)
            .catch(err => console.error(err.toString()));
    }).catch(function (err) {
        return console.error(err.toString());
    });
</script>

<script>
    document.querySelectorAll("[id^='timer-']").forEach(timer => {
        const closingTime = new Date(timer.dataset.closingTime);

        function updateTimer() {
            const now = new Date();
            const diff = closingTime - now;

            if (diff <= 0) {
                timer.textContent = "Bidding Closed";
                timer.style.color = "red";
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff / (1000 * 60)) % 60);
            const seconds = Math.floor((diff / 1000) % 60);

            timer.textContent = `${hours}h ${minutes}m ${seconds}s`;
        }

        updateTimer();
        setInterval(updateTimer, 1000);
    });
</script>
